#!/usr/bin/env bash
set -euo pipefail

# MOSAIC: Multi-Agent Orchestration System for Agentic Intelligence Collaboration
# Lightweight CLI dispatcher for the .hive/ framework

VERSION="1.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEMPLATE_DIR="$(cd "$SCRIPT_DIR/../template" && pwd)"
HIVE_DIR=".hive"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

info()  { echo -e "${BLUE}[hive]${NC} $*"; }
ok()    { echo -e "${GREEN}[hive]${NC} $*"; }
warn()  { echo -e "${YELLOW}[hive]${NC} $*"; }
err()   { echo -e "${RED}[hive]${NC} $*" >&2; }

# ─── Init ───────────────────────────────────────────────────────────────────

cmd_init() {
    if [[ -d "$HIVE_DIR" ]]; then
        err ".hive/ already exists. Remove it first if you want to reinitialize."
        exit 1
    fi

    info "Initializing MOSAIC .hive/ structure..."

    # Copy template files
    cp -r "$TEMPLATE_DIR/.hive" .
    [[ ! -f "AGENTS.md" ]] && cp "$TEMPLATE_DIR/AGENTS.md" .
    [[ ! -f "CLAUDE.md" ]] && cp "$TEMPLATE_DIR/CLAUDE.md" .
    [[ ! -f "GEMINI.md" ]] && cp "$TEMPLATE_DIR/GEMINI.md" .

    # Copy .claude/ skills and agents if not present
    if [[ ! -d ".claude" ]]; then
        cp -r "$TEMPLATE_DIR/.claude" .
    else
        # Merge in skills and agents without overwriting existing
        if [[ -d "$TEMPLATE_DIR/.claude/skills" ]]; then
            mkdir -p .claude/skills
            for skill_dir in "$TEMPLATE_DIR/.claude/skills"/*/; do
                skill_name="$(basename "$skill_dir")"
                if [[ ! -d ".claude/skills/$skill_name" ]]; then
                    cp -r "$skill_dir" ".claude/skills/"
                fi
            done
        fi
        if [[ -d "$TEMPLATE_DIR/.claude/agents" ]]; then
            mkdir -p .claude/agents
            for agent_file in "$TEMPLATE_DIR/.claude/agents"/*.md; do
                agent_name="$(basename "$agent_file")"
                if [[ ! -f ".claude/agents/$agent_name" ]]; then
                    cp "$agent_file" ".claude/agents/"
                fi
            done
        fi
    fi

    # Append to .gitignore if needed
    if [[ -f ".gitignore" ]]; then
        if ! grep -q ".hive/sessions/current.md" .gitignore 2>/dev/null; then
            echo "" >> .gitignore
            echo "# MOSAIC" >> .gitignore
            echo ".hive/sessions/current.md" >> .gitignore
            echo ".hive/transfers/latest.md" >> .gitignore
        fi
    else
        cp "$TEMPLATE_DIR/.gitignore" .
    fi

    ok "MOSAIC initialized!"
    echo ""
    echo "  Created:"
    echo "    .hive/           — Coordination framework"
    echo "    AGENTS.md        — Universal agent instructions"
    echo "    CLAUDE.md        — Claude Code instructions"
    echo "    GEMINI.md        — Gemini CLI instructions"
    echo "    .claude/skills/  — Claude Code slash commands"
    echo "    .claude/agents/  — Cross-agent subagent wrappers"
    echo ""
    echo "  Next steps:"
    echo "    1. Edit .hive/context/project-brief.md with your project info"
    echo "    2. Edit AGENTS.md with your build/test/lint commands"
    echo "    3. Add tasks to .hive/tasks/active.md"
    echo "    4. Start working with any agent!"

    # Auto-commit if in a git repo
    if git rev-parse --is-inside-work-tree &>/dev/null; then
        echo ""
        read -rp "  Commit .hive/ to git? [Y/n] " answer
        if [[ "${answer:-Y}" =~ ^[Yy]$ ]]; then
            git add .hive/ AGENTS.md CLAUDE.md GEMINI.md .gitignore .claude/ 2>/dev/null || true
            git commit -m "chore: initialize MOSAIC .hive/ structure"
            ok "Committed to git."
        fi
    fi
}

# ─── Status ─────────────────────────────────────────────────────────────────

cmd_status() {
    if [[ ! -d "$HIVE_DIR" ]]; then
        err "No .hive/ directory found. Run 'hive init' first."
        exit 1
    fi

    echo -e "${BOLD}MOSAIC Status${NC}"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    # Session
    echo -e "\n${BOLD}Session${NC}"
    if [[ -f "$HIVE_DIR/sessions/current.md" ]]; then
        local agent working_on
        agent=$(grep -oP '^\- \*\*Agent\*\*: \K.+' "$HIVE_DIR/sessions/current.md" 2>/dev/null || echo "_none_")
        working_on=$(grep -oP '^\- \*\*Working On\*\*: \K.+' "$HIVE_DIR/sessions/current.md" 2>/dev/null || echo "_N/A_")
        echo "  Agent:      $agent"
        echo "  Working on: $working_on"
    else
        echo "  No session file found."
    fi

    # Tasks
    echo -e "\n${BOLD}Active Tasks${NC}"
    if [[ -f "$HIVE_DIR/tasks/active.md" ]]; then
        local task_count
        task_count=$(grep -c '^### TASK-' "$HIVE_DIR/tasks/active.md" 2>/dev/null || echo "0")
        if [[ "$task_count" -gt 0 ]]; then
            grep '^### TASK-' "$HIVE_DIR/tasks/active.md" | while read -r line; do
                echo "  $line"
            done
        else
            echo "  No active tasks."
        fi
    else
        echo "  No task file found."
    fi

    # Latest transfer
    echo -e "\n${BOLD}Latest Transfer${NC}"
    if [[ -f "$HIVE_DIR/transfers/latest.md" ]]; then
        local from_agent summary
        from_agent=$(grep -oP '^\- \*\*From Agent\*\*: \K.+' "$HIVE_DIR/transfers/latest.md" 2>/dev/null || echo "unknown")
        summary=$(sed -n '/^## Summary$/,/^##/{/^## Summary$/d;/^##/d;p;}' "$HIVE_DIR/transfers/latest.md" 2>/dev/null | head -3 | sed 's/^/  /')
        echo "  From: $from_agent"
        if [[ -n "$summary" ]]; then
            echo "$summary"
        fi
    else
        echo "  No transfer notes yet."
    fi

    # Git state
    echo -e "\n${BOLD}Git State${NC}"
    if git rev-parse --is-inside-work-tree &>/dev/null; then
        local branch uncommitted last_commit
        branch=$(git branch --show-current 2>/dev/null || echo "detached")
        uncommitted=$(git status --short 2>/dev/null | wc -l | tr -d ' ')
        last_commit=$(git log --oneline -1 2>/dev/null || echo "no commits")
        echo "  Branch:     $branch"
        echo "  Uncommitted: $uncommitted file(s)"
        echo "  Last commit: $last_commit"
    else
        echo "  Not a git repository."
    fi

    echo ""
}

# ─── Relay ──────────────────────────────────────────────────────────────────

cmd_relay() {
    if [[ ! -d "$HIVE_DIR" ]]; then
        err "No .hive/ directory found. Run 'hive init' first."
        exit 1
    fi

    local from_agent="${1:-}"
    local to_agent="${2:-}"

    if [[ -z "$from_agent" || -z "$to_agent" ]]; then
        err "Usage: hive relay <from-agent> <to-agent>"
        err "Example: hive relay claude gemini"
        exit 1
    fi

    info "Preparing relay from $from_agent to $to_agent..."

    # Archive existing latest.md
    if [[ -f "$HIVE_DIR/transfers/latest.md" ]]; then
        local timestamp
        timestamp=$(date +"%Y-%m-%dT%H-%M-%S")
        local archive_name="${timestamp}_${from_agent}.md"
        mv "$HIVE_DIR/transfers/latest.md" "$HIVE_DIR/transfers/archive/$archive_name"
        ok "Archived previous transfer note → archive/$archive_name"
    fi

    # Resolve CLI command from roster
    local cli_cmd=""
    if [[ -f "$HIVE_DIR/roster.yaml" ]]; then
        cli_cmd=$(grep -A2 "  ${to_agent}:" "$HIVE_DIR/roster.yaml" 2>/dev/null | grep "cli_command:" | sed 's/.*: *"\(.*\)"/\1/' || true)
    fi

    echo ""
    echo -e "${BOLD}Relay: $from_agent → $to_agent${NC}"
    echo ""
    echo "  Next steps:"
    echo "    1. Review/create .hive/transfers/latest.md with handoff notes"
    if [[ -n "$cli_cmd" ]]; then
        echo "    2. Start the next agent: ${BOLD}$cli_cmd${NC}"
    else
        echo "    2. Start the next agent ($to_agent)"
    fi
    echo "    3. The new agent will read AGENTS.md → .hive/transfers/latest.md"
    echo ""

    # Clear session
    if [[ -f "$HIVE_DIR/sessions/current.md" ]]; then
        cat > "$HIVE_DIR/sessions/current.md" << 'SESSIONEOF'
# Current Session

> Updated by each agent when starting and finishing work.

## Active Session

- **Agent**: _none_
- **Started**: _N/A_
- **Working On**: _N/A_
- **Task Reference**: _N/A_

## Session Log

| Timestamp | Agent | Action | Task | Notes |
|-----------|-------|--------|------|-------|
SESSIONEOF
        local ts
        ts=$(date +"%Y-%m-%dT%H:%M:%S")
        echo "| $ts | $from_agent | relay-out | — | Handing off to $to_agent |" >> "$HIVE_DIR/sessions/current.md"
    fi

    ok "Session cleared. Ready for $to_agent."
}

# ─── Ensemble ───────────────────────────────────────────────────────────────

cmd_ensemble() {
    if [[ ! -d "$HIVE_DIR" ]]; then
        err "No .hive/ directory found. Run 'hive init' first."
        exit 1
    fi

    local subcmd="${1:-}"

    case "$subcmd" in
        start)
            shift
            ensemble_start "$@"
            ;;
        merge)
            shift
            ensemble_merge "$@"
            ;;
        *)
            err "Usage: hive ensemble <start|merge>"
            err ""
            err "  hive ensemble start <name-a> <name-b> [...]  Create parallel branches"
            err "  hive ensemble merge                          Merge all stream/ branches"
            exit 1
            ;;
    esac
}

ensemble_start() {
    if [[ $# -lt 2 ]]; then
        err "Usage: hive ensemble start <stream-a> <stream-b> [...]"
        err "Example: hive ensemble start auth-backend auth-frontend"
        exit 1
    fi

    if ! git rev-parse --is-inside-work-tree &>/dev/null; then
        err "Not a git repository. Ensemble requires git."
        exit 1
    fi

    local repo_root
    repo_root=$(git rev-parse --show-toplevel)
    local base_branch
    base_branch=$(git branch --show-current)
    local worktree_base="$repo_root/.hive/worktrees"
    mkdir -p "$worktree_base"

    info "Creating parallel streams from $base_branch..."

    for stream in "$@"; do
        local branch="stream/$stream"
        local wt_path="$worktree_base/$stream"

        if [[ -d "$wt_path" ]]; then
            warn "Worktree $wt_path already exists, skipping."
            continue
        fi

        # Create branch + worktree in one step
        git worktree add -b "$branch" "$wt_path" "$base_branch" 2>/dev/null || {
            # Branch may already exist, try without -b
            git worktree add "$wt_path" "$branch" 2>/dev/null || {
                warn "Could not create worktree for $stream, skipping."
                continue
            }
        }
        ok "Created: $wt_path (branch: $branch)"
    done

    echo ""
    echo -e "${BOLD}Ensemble streams created:${NC}"
    echo ""
    echo "  Each stream is a separate directory (git worktree) with its own branch."
    echo "  Agents can work in parallel without interfering with each other."
    echo ""
    for stream in "$@"; do
        echo "  stream/$stream:"
        echo "    Path:   $worktree_base/$stream"
        echo "    Branch: stream/$stream"
        echo ""
    done
    echo "  Start agents in separate terminals:"
    for stream in "$@"; do
        echo "    cd $worktree_base/$stream && <agent-cli>"
    done
    echo ""
    echo "  When done, come back to this directory and run:"
    echo "    hive ensemble merge"
}

ensemble_merge() {
    if ! git rev-parse --is-inside-work-tree &>/dev/null; then
        err "Not a git repository."
        exit 1
    fi

    local repo_root
    repo_root=$(git rev-parse --show-toplevel)
    local base_branch
    base_branch=$(git branch --show-current)
    local worktree_base="$repo_root/.hive/worktrees"

    # Find stream branches
    local streams
    streams=$(git branch --list 'stream/*' | sed 's/^[* +]*//')

    if [[ -z "$streams" ]]; then
        err "No stream/ branches found."
        exit 1
    fi

    echo -e "${BOLD}Merging streams into $base_branch:${NC}"
    while read -r branch; do
        echo "  $branch"
    done <<< "$streams"
    echo ""

    read -rp "Proceed? [Y/n] " answer
    if [[ ! "${answer:-Y}" =~ ^[Yy]$ ]]; then
        info "Aborted."
        exit 0
    fi

    while read -r branch; do
        info "Merging $branch..."
        if git merge "$branch" --no-edit; then
            ok "Merged $branch"
        else
            err "Conflict merging $branch. Resolve manually, then run 'hive ensemble merge' again."
            return 1
        fi
    done <<< "$streams"

    echo ""
    read -rp "Delete stream branches and worktrees? [Y/n] " answer
    if [[ "${answer:-Y}" =~ ^[Yy]$ ]]; then
        while read -r branch; do
            local stream_name="${branch#stream/}"
            local wt_path="$worktree_base/$stream_name"
            # Remove worktree first (if it exists), then branch
            if [[ -d "$wt_path" ]]; then
                git worktree remove "$wt_path" --force 2>/dev/null && ok "Removed worktree: $wt_path"
            fi
            git branch -d "$branch" 2>/dev/null && ok "Deleted branch: $branch"
        done <<< "$streams"

        # Clean up empty worktrees dir
        rmdir "$worktree_base" 2>/dev/null || true
    fi

    ok "Ensemble merge complete."
}

# ─── Roster ─────────────────────────────────────────────────────────────────

cmd_roster() {
    if [[ ! -d "$HIVE_DIR" ]]; then
        err "No .hive/ directory found. Run 'hive init' first."
        exit 1
    fi

    local subcmd="${1:-list}"

    case "$subcmd" in
        list)
            echo -e "${BOLD}Agent Roster${NC}"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            if [[ -f "$HIVE_DIR/roster.yaml" ]]; then
                # Simple display of agents from roster
                grep -E '^  [a-z].*:$' "$HIVE_DIR/roster.yaml" | grep -v "routing:" | while read -r line; do
                    local name
                    name=$(echo "$line" | sed 's/://;s/^ *//')
                    local cli
                    cli=$(grep -A3 "  ${name}:" "$HIVE_DIR/roster.yaml" | grep "cli_command:" | sed 's/.*: *"\(.*\)"/\1/' || echo "?")
                    echo "  $name  →  $cli"
                done
            else
                echo "  No roster file found."
            fi
            echo ""
            ;;
        add)
            local agent_name="${2:-}"
            local agent_cli="${3:-}"
            if [[ -z "$agent_name" || -z "$agent_cli" ]]; then
                err "Usage: hive roster add <name> <cli-command>"
                err "Example: hive roster add aider aider"
                exit 1
            fi
            warn "Manual roster editing recommended. Edit .hive/roster.yaml directly."
            info "Add under 'agents:' section:"
            echo ""
            echo "  ${agent_name}:"
            echo "    name: \"${agent_name}\""
            echo "    cli_command: \"${agent_cli}\""
            echo "    instruction_files:"
            echo "      - \"AGENTS.md\""
            echo "    context_window: 200000"
            echo "    strengths:"
            echo "      - \"TBD\""
            echo "    best_for:"
            echo "      - \"TBD\""
            ;;
        *)
            err "Usage: hive roster [list|add <name> <cli>]"
            exit 1
            ;;
    esac
}

# ─── Help ───────────────────────────────────────────────────────────────────

cmd_help() {
    echo -e "${BOLD}MOSAIC${NC} — Multi-Agent Orchestration System v${VERSION}"
    echo ""
    echo "Usage: hive <command> [options]"
    echo ""
    echo "Commands:"
    echo "  init                          Initialize .hive/ in current project"
    echo "  status                        Show current tasks, session, transfers"
    echo "  relay <from> <to>             Prepare relay handoff between agents"
    echo "  ensemble start <a> <b> [...]  Create worktrees for parallel streams"
    echo "  ensemble merge                Merge all stream/ branches + cleanup"
    echo "  roster [list|add]             View or manage agent roster"
    echo "  help                          Show this help message"
    echo ""
    echo "Examples:"
    echo "  hive init                     # Set up MOSAIC in your project"
    echo "  hive status                   # Check what's happening"
    echo "  hive relay claude gemini      # Hand off from Claude to Gemini"
    echo "  hive ensemble start api ui    # Create parallel work streams"
    echo "  hive ensemble merge           # Merge parallel work back together"
    echo ""
}

# ─── Main ───────────────────────────────────────────────────────────────────

main() {
    local cmd="${1:-help}"
    shift 2>/dev/null || true

    case "$cmd" in
        init)       cmd_init "$@" ;;
        status)     cmd_status "$@" ;;
        relay)      cmd_relay "$@" ;;
        ensemble)   cmd_ensemble "$@" ;;
        roster)     cmd_roster "$@" ;;
        help|--help|-h) cmd_help ;;
        version|--version|-v) echo "hive v${VERSION}" ;;
        *)
            err "Unknown command: $cmd"
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"
